language: python
sudo: required
dist: trusty
cache:
  directories:
  - "$HOME/lxc"
  pip: true
matrix:
  fast_finish: true
env:
- ANSIBLE_GIT_VERSION='devel' # 2.6.x development branch
- ANSIBLE_VERSION='<2.6.0' # 2.5.x
- ANSIBLE_VERSION='<2.5.0' # 2.4.x
- ANSIBLE_VERSION='<2.4.0' # 2.3.x
before_cache:
- sudo mkdir $HOME/lxc && sudo tar cf $HOME/lxc/cache.tar /var/cache/lxc/ && sudo
  chown $USER. $HOME/lxc/cache.tar
install:
- sudo tar xf $HOME/lxc/cache.tar -C / || true
- if [ "$ANSIBLE_GIT_VERSION" ]; then git clone --depth=1 git+https://github.com/ansible/ansible.git@$ANSIBLE_GIT_VERSION
  $HOME/ansible; pip install git+file://$HOME/ansible/; elif [ "$ANSIBLE_VERSION"
  ]; then pip install "ansible${ANSIBLE_VERSION}"; else pip install ansible; fi
- ansible --version
# The following is needed for default Ansible 2.3 installations
- 'sudo mkdir -p /etc/ansible/roles && sudo chown $(whoami): /etc/ansible/roles'
- git archive --format tar.gz HEAD > lae.travis-lxc.tar.gz && ansible-galaxy install
  lae.travis-lxc.tar.gz,$(git rev-parse HEAD),lae.travis-lxc
before_script: cd tests/
script:
- ansible-playbook -i inventory deploy.yml --syntax-check
- ANSIBLE_STDOUT_CALLBACK=debug ansible-playbook -i inventory -v deploy.yml
- unbuffer ansible-playbook -i inventory deploy.yml >idempotency.log 2>&1
- 'grep -A1 "PLAY RECAP" idempotency.log | grep -qP "changed=0.*failed=0" && (echo
  "Idempotence: PASS"; exit 0) || (echo "Idempotence: FAIL"; cat idempotency.log;
  exit 1)'
- ANSIBLE_STDOUT_CALLBACK=debug ansible-playbook -i inventory -v test.yml
notifications:
  webhooks: https://galaxy.ansible.com/api/v1/notifications/
  irc:
    on_success: change
    channels:
      secure: "uNnWy3ToabL7W4mP2jTqdbV3do408Sl4N53D9T3vvcpCOLrdHeSagq+Juto3q4Z2bF/zpwHp05y5pJU0N3Fsb4W1C2jUnGvbwEYFRK+cTUsMUT+rrcHByF2e/nMBi1GEPysGfXtNMlEIe+rlKNTCFvfngnp2lTmcs4QBtQh+eS1YQBr8mdizCDWi28FygMTma87VdQ10Af0XkXWHgVHYfh4MARGfkMmCWjZqBHaKV5xTZ7xVzndGN7T3XiehRnD44iQNT6PaYZFRqUWV8S8BROhwOZIlgwEX3t/gxiGKLOHoI/cubm2H8aKEhSMl18MUZxET7CK4vwVpEnlqTQihsLkkuM7zfvsUWEQA03ZsZDAAnnIykbfQDMVBexOfZwv/5xdX5qTy2aghr7c/+LUf8N86Hj+TDGfWBioNhuPYBj5lghw0a+p002kKjjmgr2tTZpghIdHzmRqjne2ZbcIH3lBMWftzDHtBxuUTAaxaGP75VqH0JF5lGUvZL49VPtb8tGff0BVi0+YuHdlDAoIL6ACC6qQlgyVEZhZ170QS0Ez9s+pkMa1rpj4BsxBKZog3TKEad4K+CcewarwCgCEGxG2S4E1ugeZoCVtP8Gr4CC/51axhbATCPqYSQnNXKXo6vP3Gw3VBOcKx/Ku8uR+Kcdj7oEoAcJRF5eZFMG1y5Wk="
  slack:
    on_success: change
    rooms:
      secure: "KBVbiB1uV7C56jewVHy9X4xLE6RcNfZwEmjknSQOFWa0kgdiS40tDW9UJNE0AJ+Fs26tKT6sYI0KvlqS+OYkNtTq54vxfpiWkDj7fyfvuKsBfWgQll99y0Tm+CffLDtWwCv9+95qifaV6JwYM3bk6t2DPS7yzvLPrqqYxmJ2sAC99ulnueSdT/LpcSfXh8zCSr1DyfHkGfu6Cj32YPYstN8tSB8kjWZfulRVP5yYfBxhKbngv5NCsMMfappaSYK2W2HbYbJW5ZLPzJcbu2ynWTHZcmWHGFTdFLzOixNEAL5Gpqfgub+MZxxUrfekVdb8IM+eIeDJcNe7CATp35p/+mzXU+BZm5gsLTltoQb1ykUDRBW7cKulCoG7kCNN+qijWUcQYEaTkPmZToQ1Q1BiktOAcPnGWmPGKPxVuKL58BFIAfxAMWXlG1V6M+giq9nUSqzDHd6p62UE1IR5ws0o/pUwJERyjrZr1VzQyaaqPiYpqDvg5DjTtZQFivLIt8wKukDXivB7BuP4BFWUJwUXjoLFcAck8QZ9i2+5PyKE7sjRF5O2/BZls9Ql/vAnCwUaXMekzpSVuxEL/XvE4PI9nmp5T2tISuT7cCskfoy8dpJfUi75sE85D04TY3Y3XWr91ubCwJrKnVIBD/NPIKR56xs204EmIcwi39qskzZAShc="
