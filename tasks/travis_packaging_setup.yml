---
- block:
  # This needs to be done using a command module because the apt module is
  # broken in the Travis CI virtualenv by default.
  # The version is pinned to 1.2.10 to ensure that the version from apt-backport
  # is installed - which Travis CI appears to use.
  - name: Install libapt-pkg-dev as build dependency for python-apt
    command: "apt-get install -y libapt-pkg-dev=1.2.10"
    args:
      creates: /usr/lib/x86_64-linux-gnu/libapt-pkg.so
      warn: False
    retries: 3

  # 1.1.0_beta5 is compatible with the above package
  - name: Clone the python-apt source repository
    git:
      repo: https://git.launchpad.net/python-apt
      dest: /usr/local/src/python-apt
      version: 1.1.0_beta5
      depth: 1
    retries: 3
  become: True

# After this task, the apt module can be used without problem. There's no need
# to be root while running this, so it's outside of the blocks.
- name: Install the python-apt library from local source
  pip:
    name: file:///usr/local/src/python-apt
    virtualenv: "{{ lookup('env', 'VIRTUAL_ENV') }}"

- block:
  - name: Configure LXC PPA
    apt_repository:
      repo: "ppa:ubuntu-lxc/stable"

  - name: Install needed packages
    apt:
      name: "{{ item }}"
      update_cache: yes
      cache_valid_time: 3600
      state: latest
    with_items: "{{ travis_lxc_packages }}"
    retries: 3
  become: True

- name: Install LXC Python library
  pip:
    name: "{{ 'https://github.com/lxc/python3-lxc/archive/python3-lxc-3.0.1.tar.gz' if ansible_python.version.major == 3 else 'lxc_python2' }}"
    virtualenv: "{{ lookup('env', 'VIRTUAL_ENV') }}"
  retries: 3

- name: Identify Travis CI's local Ubuntu mirror
  shell: 'apt-cache policy python | grep -m1 -oP "https?://.*?/ubuntu"'
  changed_when: False
  register: __travis_ubuntu_mirror_lookup

- name: Set fact for which mirror to use for Ubuntu LXC containers
  set_fact:
    __travis_ubuntu_mirror: "{{ __travis_ubuntu_mirror_lookup.stdout if __travis_ubuntu_mirror_lookup.stdout != '' else 'http://mirror.math.princeton.edu/pub/ubuntu' }}"
